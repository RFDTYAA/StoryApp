(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class R{constructor(){this.presenter=null,this.map=null}setPresenter(e){this.presenter=e}render(){document.getElementById("app-content").innerHTML=`
      <div class="home-container">
        <h2>Daftar Cerita</h2>
        <div id="map-home" style="height:320px;margin-bottom:16px"></div>
        <div id="stories-container"></div>
      </div>
    `}showLoading(){const e=document.getElementById("stories-container");e.innerHTML="<p>Memuat cerita...</p>"}hideLoading(){}renderStories(e){const t=document.getElementById("stories-container");t.innerHTML="",e.forEach(r=>{const s=document.createElement("div");s.className="card",s.innerHTML=`
        <img src="${r.photoUrl}" alt="${r.name}" />
        <div class="card-content">
          <h3>${r.name}</h3>
          <p>${r.description}</p>
          <small>${r.createdAt}</small>
          <button class="save-offline-btn">Simpan Offline</button>
        </div>
      `,s.querySelector(".save-offline-btn").addEventListener("click",()=>{this.presenter.saveStoryForOffline(r)}),t.appendChild(s)})}renderMap(e){const t=document.getElementById("map-home");this.map&&this.map.remove();const r=[-2.5489,118.0149];this.map=L.map(t).setView(r,5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this.map),e.forEach(s=>{s.lat&&s.lon&&L.marker([s.lat,s.lon]).addTo(this.map).bindPopup(`<strong>${s.name}</strong>`)})}showError(e){document.getElementById("stories-container").innerHTML=`<p style="color:red;">${e}</p>`}showSuccess(e){alert(e)}}class V{constructor(){this.map=null,this.mediaStream=null,this.presenter=null}setPresenter(e){this.presenter=e}render(){document.getElementById("app-content").innerHTML=`
      <div class="add-story-container">
        <h2>Tambah Cerita Baru</h2>
        <form id="add-story-form">
          <textarea id="description" placeholder="Deskripsi..." required></textarea>
          <video id="camera-preview" autoplay muted playsinline></video>
          <canvas id="photo-canvas" style="display:none;"></canvas>
          <button type="button" id="capture-btn">Ambil Gambar</button>
          <div id="map-picker" style="height:300px;"></div>
          <input type="hidden" id="latitude">
          <input type="hidden" id="longitude">
          <button type="submit">Unggah Cerita</button>
        </form>
      </div>
    `,this.presenter&&(this.presenter.startCamera(),this.presenter.initMap([-2.5489,118.0149])),this._bindEvents()}_bindEvents(){document.getElementById("capture-btn").addEventListener("click",()=>{const e=document.getElementById("camera-preview"),t=document.getElementById("photo-canvas");t.width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0),t.style.display="block"}),document.getElementById("add-story-form").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("description").value,r=document.getElementById("latitude").value,s=document.getElementById("longitude").value;document.getElementById("photo-canvas").toBlob(i=>{this.presenter.submitStory(t,r,s,i)},"image/jpeg")})}showCameraStream(e){this.mediaStream=e,document.getElementById("camera-preview").srcObject=e}stopCameraStream(){this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null)}renderMap(e){this.map=L.map("map-picker").setView(e,5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this.map);const t=L.marker(e,{draggable:!0}).addTo(this.map);t.on("dragend",()=>{const r=t.getLatLng();document.getElementById("latitude").value=r.lat,document.getElementById("longitude").value=r.lng})}showLoading(){alert("Mengunggah...")}hideLoading(){}showSuccess(e){alert(e)}showError(e){alert(e)}}class N{constructor(){this.API_ENDPOINT="https://story-api.dicoding.dev/v1"}async login(e,t){const r=await fetch(`${this.API_ENDPOINT}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),s=await r.json();if(!r.ok)throw new Error(s.message||"Login gagal, periksa email dan password.");return localStorage.setItem("token",s.loginResult.token),localStorage.setItem("name",s.loginResult.name),s}async register(e,t,r){const s=await fetch(`${this.API_ENDPOINT}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:r})}),o=await s.json();if(!s.ok)throw new Error(o.message||"Registrasi gagal.");return o}}const W=Object.freeze(Object.defineProperty({__proto__:null,AuthModel:N},Symbol.toStringTag,{value:"Module"})),w=()=>{const n=localStorage.getItem("token"),e=document.getElementById("nav-home"),t=document.getElementById("nav-add"),r=document.getElementById("nav-saved"),s=document.getElementById("nav-login"),o=document.getElementById("nav-register"),i=document.getElementById("nav-logout");!e||!t||!r||!s||!o||!i||(n?(e.style.display="inline-block",t.style.display="inline-block",r.style.display="inline-block",s.style.display="none",o.style.display="none",i.style.display="inline-block"):(e.style.display="none",t.style.display="none",r.style.display="none",s.style.display="inline-block",o.style.display="inline-block",i.style.display="none"))},U=()=>{const n=document.getElementById("logout-button");n&&n.addEventListener("click",()=>{localStorage.removeItem("token"),w(),window.location.hash="#/login"})};class F{constructor(e,t){this.model=e,this.view=t}async login(e,t){try{const r=await this.model.login(e,t);this.view.showSuccess(`Selamat datang, ${r.loginResult.name}`),w(),window.location.hash="#/home"}catch(r){this.view.showError(r.message)}}}class q{render(){const e=document.getElementById("app-content");e.innerHTML=`
      <h2>Login</h2>
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Email" />
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Masuk</button>
      <p id="loginStatus"></p>
    `,this.afterRender()}async afterRender(){const e=new N,t=new F(e,this);document.getElementById("loginBtn").addEventListener("click",()=>{const r=document.getElementById("email").value,s=document.getElementById("password").value;t.login(r,s)})}showSuccess(e){const t=document.getElementById("loginStatus");t?(t.textContent=e,t.style.color="green"):console.error("Elemen #loginStatus tidak ditemukan di halaman login")}showError(e){const t=document.getElementById("loginStatus");t?(t.textContent=`Gagal: ${e}`,t.style.color="red"):console.error("Elemen #loginStatus tidak ditemukan di halaman login")}}const G="modulepreload",K=function(n){return"/"+n},T={},z=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){let i=function(c){return Promise.all(c.map(m=>Promise.resolve(m).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),d=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=i(t.map(c=>{if(c=K(c),c in T)return;T[c]=!0;const m=c.endsWith(".css"),h=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const l=document.createElement("link");if(l.rel=m?"stylesheet":G,m||(l.as="script"),l.crossOrigin="",l.href=c,d&&l.setAttribute("nonce",d),document.head.appendChild(l),m)return new Promise((j,H)=>{l.addEventListener("load",j),l.addEventListener("error",()=>H(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return s.then(i=>{for(const a of i||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})};class J{constructor(e,t){this.model=e,this.view=t}async register(e,t,r){try{const s=await this.model.register(e,t,r);this.view.showSuccess("Registrasi berhasil. Silakan login."),setTimeout(()=>window.location.hash="#/login",900)}catch(s){this.view.showError(s.message||"Gagal registrasi.")}}}class Y{constructor(){this.presenter=null}render(){const e=document.getElementById("app-content");e.innerHTML=`
      <div class="form-container">
        <h2>Daftar</h2>
        <label for="name">Nama</label>
        <input id="reg-name" type="text" />
        <label for="email">Email</label>
        <input id="reg-email" type="email" />
        <label for="password">Password</label>
        <input id="reg-password" type="password" />
        <button id="reg-btn">Daftar</button>
        <p id="reg-status"></p>
      </div>
    `,this.afterRender()}afterRender(){z(async()=>{const{AuthModel:e}=await Promise.resolve().then(()=>W);return{AuthModel:e}},void 0).then(({AuthModel:e})=>{this.presenter=new J(new e,this),document.getElementById("reg-btn").addEventListener("click",()=>{const t=document.getElementById("reg-name").value,r=document.getElementById("reg-email").value,s=document.getElementById("reg-password").value;this.presenter.register(t,r,s)})})}showSuccess(e){const t=document.getElementById("reg-status");t&&(t.style.color="green",t.textContent=e)}showError(e){const t=document.getElementById("reg-status");t&&(t.style.color="red",t.textContent=e)}}class Z{constructor(){this.presenter=null}setPresenter(e){this.presenter=e}render(){document.getElementById("app-content").innerHTML=`
      <div class="saved-container">
        <h2>Cerita Tersimpan</h2>
        <div id="saved-stories"></div>
      </div>
    `,this.presenter.loadSaved()}renderSavedStories(e){const t=document.getElementById("saved-stories");if(t.innerHTML="",!e.length){t.innerHTML="<p>Tidak ada cerita tersimpan.</p>";return}e.forEach(r=>{const s=document.createElement("div");s.className="card",s.innerHTML=`
        <img src="${r.photoUrl}" alt="${r.name}" />
        <div class="card-content">
          <h3>${r.name}</h3>
          <p>${r.description}</p>
          <small>${r.createdAt}</small>
          <button class="delete-btn">Hapus</button>
        </div>
      `,s.querySelector(".delete-btn").addEventListener("click",()=>{this.presenter.deleteStory(r.id)}),t.appendChild(s)})}showError(e){document.getElementById("saved-stories").innerHTML=`<p style="color:red;">${e}</p>`}}const b=(n,e)=>e.some(t=>n instanceof t);let M,D;function Q(){return M||(M=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function X(){return D||(D=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const I=new WeakMap,v=new WeakMap,f=new WeakMap;function ee(n){const e=new Promise((t,r)=>{const s=()=>{n.removeEventListener("success",o),n.removeEventListener("error",i)},o=()=>{t(u(n.result)),s()},i=()=>{r(n.error),s()};n.addEventListener("success",o),n.addEventListener("error",i)});return f.set(e,n),e}function te(n){if(I.has(n))return;const e=new Promise((t,r)=>{const s=()=>{n.removeEventListener("complete",o),n.removeEventListener("error",i),n.removeEventListener("abort",i)},o=()=>{t(),s()},i=()=>{r(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",o),n.addEventListener("error",i),n.addEventListener("abort",i)});I.set(n,e)}let B={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return I.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return u(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function x(n){B=n(B)}function ne(n){return X().includes(n)?function(...e){return n.apply(P(this),e),u(this.request)}:function(...e){return u(n.apply(P(this),e))}}function re(n){return typeof n=="function"?ne(n):(n instanceof IDBTransaction&&te(n),b(n,Q())?new Proxy(n,B):n)}function u(n){if(n instanceof IDBRequest)return ee(n);if(v.has(n))return v.get(n);const e=re(n);return e!==n&&(v.set(n,e),f.set(e,n)),e}const P=n=>f.get(n);function se(n,e,{blocked:t,upgrade:r,blocking:s,terminated:o}={}){const i=indexedDB.open(n,e),a=u(i);return r&&i.addEventListener("upgradeneeded",d=>{r(u(i.result),d.oldVersion,d.newVersion,u(i.transaction),d)}),t&&i.addEventListener("blocked",d=>t(d.oldVersion,d.newVersion,d)),a.then(d=>{o&&d.addEventListener("close",()=>o()),s&&d.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const oe=["get","getKey","getAll","getAllKeys","count"],ie=["put","add","delete","clear"],E=new Map;function C(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(E.get(e))return E.get(e);const t=e.replace(/FromIndex$/,""),r=e!==t,s=ie.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(s||oe.includes(t)))return;const o=async function(i,...a){const d=this.transaction(i,s?"readwrite":"readonly");let c=d.store;return r&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),s&&d.done]))[0]};return E.set(e,o),o}x(n=>({...n,get:(e,t,r)=>C(e,t)||n.get(e,t,r),has:(e,t)=>!!C(e,t)||n.has(e,t)}));const ae=["continue","continuePrimaryKey","advance"],A={},k=new WeakMap,$=new WeakMap,ce={get(n,e){if(!ae.includes(e))return n[e];let t=A[e];return t||(t=A[e]=function(...r){k.set(this,$.get(this)[e](...r))}),t}};async function*de(...n){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...n)),!e)return;e=e;const t=new Proxy(e,ce);for($.set(t,e),f.set(t,P(e));e;)yield t,e=await(k.get(t)||e.continue()),k.delete(t)}function O(n,e){return e===Symbol.asyncIterator&&b(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&b(n,[IDBIndex,IDBObjectStore])}x(n=>({...n,get(e,t,r){return O(e,t)?de:n.get(e,t,r)},has(e,t){return O(e,t)||n.has(e,t)}}));const le="story-db",g="stories",y={async getDB(){return se(le,1,{upgrade(n){n.objectStoreNames.contains(g)||n.createObjectStore(g,{keyPath:"id"})}})},async getAllStories(){return(await this.getDB()).getAll(g)},async putStory(n){return(await this.getDB()).put(g,n)},async deleteStory(n){return(await this.getDB()).delete(g,n)}};class S{constructor(){this.apiBase="https://story-api.dicoding.dev/v1",this.token=localStorage.getItem("token")}async getStories(){try{const e=await fetch(`${this.apiBase}/stories`,{headers:{Authorization:`Bearer ${this.token}`}});if(!e.ok)throw new Error("Gagal memuat cerita dari API");return(await e.json()).listStory||[]}catch{return console.warn("Gagal mengambil dari API, mencoba dari database lokal..."),y.getAllStories()}}async addStory(e){const t=await fetch(`${this.apiBase}/stories`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:e});if(!t.ok){const r=await t.json();throw new Error(r.message)}return t.json()}async saveStoryOffline(e){return y.putStory(e)}async getSavedStories(){return y.getAllStories()}async deleteSavedStory(e){return y.deleteStory(e)}}class ue{constructor(e,t){this.model=e,this.view=t}async loadStories(){this.view.showLoading();try{const e=await this.model.getStories();this.view.hideLoading(),this.view.renderStories(e),this.view.renderMap(e)}catch(e){this.view.hideLoading(),this.view.showError(e.message)}}async saveStoryForOffline(e){try{await this.model.saveStoryOffline(e),this.view.showSuccess("Cerita disimpan offline!")}catch(t){this.view.showError(t.message)}}}class me{constructor(e,t){this.model=e,this.view=t,this.view.setPresenter(this)}async startCamera(){try{const e=await navigator.mediaDevices.getUserMedia({video:!0});this.view.showCameraStream(e)}catch{this.view.showError("Tidak dapat mengakses kamera.")}}initMap(e){this.view.renderMap(e)}async submitStory(e,t,r,s){this.view.showLoading();try{await this.model.addStory(e,t,r,s),this.view.showSuccess("Cerita berhasil diunggah!")}catch{this.view.showError("Gagal mengunggah cerita.")}finally{this.view.hideLoading(),this.view.stopCameraStream()}}}class he{constructor(e,t){this.model=e,this.view=t}async loadSaved(){try{const e=await this.model.getSavedStories();this.view.renderSavedStories(e)}catch(e){this.view.showError(e.message)}}async deleteStory(e){try{await this.model.deleteSavedStory(e),this.loadSaved()}catch(t){this.view.showError(t.message)}}}const _=()=>{const n=window.location.hash||"#/login";if(w(),n==="#/"||n==="#/home"){const e=new S,t=new R,r=new ue(e,t);t.setPresenter(r),t.render(),r.loadStories()}else if(n==="#/add"){const e=new S,t=new V,r=new me(e,t);t.setPresenter(r),t.render()}else if(n==="#/saved"){const e=new S,t=new Z,r=new he(e,t);t.setPresenter(r),t.render(),r.loadSaved()}else n==="#/login"?new q().render():n==="#/register"?new Y().render():window.location.hash="#/login"};function p(n,e=3e3){const t=document.createElement("div");t.className="toast",t.textContent=n,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),50),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>document.body.removeChild(t),300)},e)}const ge={async init(){if(console.log("ðŸ”” Inisialisasi Notification Helper..."),!("Notification"in window)){p("Browser tidak mendukung notifikasi","error");return}await Notification.requestPermission()==="granted"?this._subscribeToPush():p("Izin notifikasi ditolak","error")},async _subscribeToPush(){try{const n=await navigator.serviceWorker.ready,e={userVisibleOnly:!0,applicationServerKey:this._urlBase64ToUint8Array("BLXy8gNJ5aM-xIf9hvC5oT2TvZf7PMq6ZbeAWSq_-DyUMva6S6T1qfKTIWyA2NYORYHxCpNuFkN34yHa0px549Q")},t=await n.pushManager.subscribe(e);console.log("Push Subscription:",JSON.stringify(t)),p("Berhasil berlangganan push notification","success")}catch(n){console.error("Gagal berlangganan push notification:",n),p("Gagal berlangganan push notification","error")}},_urlBase64ToUint8Array(n){const e="=".repeat((4-n.length%4)%4),t=(n+e).replace(/-/g,"+").replace(/_/g,"/"),r=window.atob(t),s=new Uint8Array(r.length);for(let o=0;o<r.length;++o)s[o]=r.charCodeAt(o);return s}};window.addEventListener("hashchange",_);window.addEventListener("load",()=>{w(),U(),_(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(()=>{console.log("Service Worker berhasil didaftarkan."),ge.init(),navigator.serviceWorker.addEventListener("message",n=>{n.data&&n.data.type==="SHOW_TOAST"&&p(`${n.data.title}: ${n.data.body}`,"success")})}).catch(n=>{console.error("Pendaftaran Service Worker gagal:",n)})});
