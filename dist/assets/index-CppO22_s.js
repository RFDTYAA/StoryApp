(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();const w=(n,e)=>e.some(t=>n instanceof t);let B,S;function N(){return B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return S||(S=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const E=new WeakMap,g=new WeakMap,p=new WeakMap;function $(n){const e=new Promise((t,r)=>{const o=()=>{n.removeEventListener("success",a),n.removeEventListener("error",s)},a=()=>{t(l(n.result)),o()},s=()=>{r(n.error),o()};n.addEventListener("success",a),n.addEventListener("error",s)});return p.set(e,n),e}function W(n){if(E.has(n))return;const e=new Promise((t,r)=>{const o=()=>{n.removeEventListener("complete",a),n.removeEventListener("error",s),n.removeEventListener("abort",s)},a=()=>{t(),o()},s=()=>{r(n.error||new DOMException("AbortError","AbortError")),o()};n.addEventListener("complete",a),n.addEventListener("error",s),n.addEventListener("abort",s)});E.set(n,e)}let b={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return E.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return l(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function x(n){b=n(b)}function F(n){return V().includes(n)?function(...e){return n.apply(v(this),e),l(this.request)}:function(...e){return l(n.apply(v(this),e))}}function G(n){return typeof n=="function"?F(n):(n instanceof IDBTransaction&&W(n),w(n,N())?new Proxy(n,b):n)}function l(n){if(n instanceof IDBRequest)return $(n);if(g.has(n))return g.get(n);const e=G(n);return e!==n&&(g.set(n,e),p.set(e,n)),e}const v=n=>p.get(n);function H(n,e,{blocked:t,upgrade:r,blocking:o,terminated:a}={}){const s=indexedDB.open(n,e),c=l(s);return r&&s.addEventListener("upgradeneeded",i=>{r(l(s.result),i.oldVersion,i.newVersion,l(s.transaction),i)}),t&&s.addEventListener("blocked",i=>t(i.oldVersion,i.newVersion,i)),c.then(i=>{a&&i.addEventListener("close",()=>a()),o&&i.addEventListener("versionchange",d=>o(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}const z=["get","getKey","getAll","getAllKeys","count"],K=["put","add","delete","clear"],y=new Map;function k(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(y.get(e))return y.get(e);const t=e.replace(/FromIndex$/,""),r=e!==t,o=K.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(o||z.includes(t)))return;const a=async function(s,...c){const i=this.transaction(s,o?"readwrite":"readonly");let d=i.store;return r&&(d=d.index(c.shift())),(await Promise.all([d[t](...c),o&&i.done]))[0]};return y.set(e,a),a}x(n=>({...n,get:(e,t,r)=>k(e,t)||n.get(e,t,r),has:(e,t)=>!!k(e,t)||n.has(e,t)}));const U=["continue","continuePrimaryKey","advance"],P={},I=new WeakMap,_=new WeakMap,J={get(n,e){if(!U.includes(e))return n[e];let t=P[e];return t||(t=P[e]=function(...r){I.set(this,_.get(this)[e](...r))}),t}};async function*q(...n){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...n)),!e)return;e=e;const t=new Proxy(e,J);for(_.set(t,e),p.set(t,v(e));e;)yield t,e=await(I.get(t)||e.continue()),I.delete(t)}function D(n,e){return e===Symbol.asyncIterator&&w(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&w(n,[IDBIndex,IDBObjectStore])}x(n=>({...n,get(e,t,r){return D(e,t)?q:n.get(e,t,r)},has(e,t){return D(e,t)||n.has(e,t)}}));const Q="story-app-db",X=1,h="stories",f=H(Q,X,{upgrade(n){n.createObjectStore(h,{keyPath:"id"})}}),T={async getAllStories(){return(await f).getAll(h)},async putStory(n){return(await f).put(h,n)},async putAllStories(n){const e=(await f).transaction(h,"readwrite");return n.forEach(t=>{e.store.put(t)}),e.done}};class O{constructor(){this.API_ENDPOINT="/api/v1"}getToken(){return localStorage.getItem("token")}async getStories(){try{const e=await this._fetchFromApi();return await T.putAllStories(e),e}catch{console.log("Gagal mengambil dari API, mencoba mengambil dari database lokal...");const t=await T.getAllStories();if(t&&t.length>0)return t;throw new Error("Gagal memuat cerita. Periksa koneksi internet Anda.")}}async _fetchFromApi(){const e=this.getToken();if(!e)throw new Error("Anda harus login untuk melihat cerita.");const t=await fetch(`${this.API_ENDPOINT}/stories`,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok){const o=await t.json();throw new Error(o.message||"Gagal memuat cerita dari API.")}return(await t.json()).listStory}async addStory(e){const t=this.getToken();if(!t)throw new Error("Anda harus login untuk menambah cerita.");const r=await fetch(`${this.API_ENDPOINT}/stories`,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:e}),o=await r.json();if(!r.ok)throw new Error(o.message||"Gagal menambahkan cerita.");return o}}class Y{constructor(e,t){this.model=e,this.view=t}async loadStories(){try{const e=await this.model.getStories();this.view.renderStories(e),this.view.renderMap(e)}catch(e){console.error("Gagal memuat cerita:",e),this.view.showError(e.message)}}}class C{render(){document.getElementById("app-content").innerHTML='<h2>Semua Cerita</h2><div id="storyList"></div><div id="map" style="height: 400px"></div>',this.afterRender()}async afterRender(){const e=new O;new Y(e,this).loadStories()}renderStories(e){const t=document.getElementById("storyList");t.innerHTML="",e.forEach(r=>{const o=document.createElement("div");o.className="card",o.innerHTML=`
        <img src="${r.photoUrl}" alt="Foto oleh ${r.name}" />
        <h3>${r.name}</h3>
        <p>${r.description}</p>
        <small>${new Date(r.createdAt).toLocaleString()}</small>
      `,t.appendChild(o)})}renderMap(e){const t=L.map("map").setView([-2,118],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(t),e.forEach(r=>{r.lat&&r.lon&&L.marker([r.lat,r.lon]).addTo(t).bindPopup(`<b>${r.name}</b><br>${r.description}`)})}showError(e){const t=document.getElementById("storyList");t.innerHTML=`<p class="error-message">${e}</p>`}}class Z{constructor(e,t){this.model=e,this.view=t}async addStory(e){try{this.view.showLoading(),await this.model.addStory(e),this.view.showSuccess("Cerita berhasil ditambahkan!"),window.location.hash="#/"}catch(t){this.view.showError(t.message)}finally{this.view.hideLoading()}}}class ee{constructor(){this._mediaStream=null,this.map=null,this.marker=null}render(){document.getElementById("app-content").innerHTML=`
      <div class="add-story-container">
        <h2>Tambah Cerita Baru</h2>
        <form id="add-story-form">
          <div class="form-group">
            <label for="description">Deskripsi Cerita</label>
            <textarea id="description" name="description" required></textarea>
          </div>

          <div class="form-group">
            <label>Ambil Gambar dari Kamera</label>
            <video id="camera-preview" autoplay muted playsinline></video>
            <canvas id="photo-canvas" style="display:none;"></canvas>
            <button type="button" id="capture-btn">Ambil Gambar</button>
            <img id="photo-result" style="max-width: 100%; margin-top: 10px; display: none;" />
          </div>

          <div class="form-group">
            <label>Pilih Lokasi di Peta</label>
            <div id="map-picker" style="height: 300px; width: 100%;"></div>
            <input type="hidden" id="latitude" name="lat">
            <input type="hidden" id="longitude" name="lon">
          </div>
          
          <button type="submit" id="submit-story-btn">Unggah Cerita</button>
          <p id="upload-status" class="upload-status"></p>
        </form>
      </div>
    `,this._initializeCamera(),this._initializeMap(),this._addEventListeners()}async _initializeCamera(){try{this._mediaStream=await navigator.mediaDevices.getUserMedia({video:!0});const e=document.getElementById("camera-preview");e.srcObject=this._mediaStream}catch(e){console.error("Gagal mengakses kamera:",e),alert("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.")}}_initializeMap(){const e=[-2.5489,118.0149];this.map=L.map("map-picker").setView(e,5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this.map),this.marker=L.marker(e,{draggable:!0}).addTo(this.map),this._updateCoordinates(e[0],e[1]),this.map.on("click",t=>{const{lat:r,lng:o}=t.latlng;this.marker.setLatLng([r,o]),this._updateCoordinates(r,o)}),this.marker.on("dragend",()=>{const{lat:t,lng:r}=this.marker.getLatLng();this._updateCoordinates(t,r)})}_updateCoordinates(e,t){document.getElementById("latitude").value=e,document.getElementById("longitude").value=t}_addEventListeners(){document.getElementById("capture-btn").addEventListener("click",()=>{const t=document.getElementById("camera-preview"),r=document.getElementById("photo-canvas"),o=document.getElementById("photo-result");r.width=t.videoWidth,r.height=t.videoHeight,r.getContext("2d").drawImage(t,0,0),o.src=r.toDataURL("image/jpeg"),o.style.display="block"}),document.getElementById("add-story-form").addEventListener("submit",t=>{t.preventDefault();const r=new O,o=new Z(r,this),a=document.getElementById("description").value,s=document.getElementById("latitude").value,c=document.getElementById("longitude").value,i=document.getElementById("photo-canvas");if(i.toDataURL()===document.createElement("canvas").toDataURL()){this.showError("Silakan ambil gambar terlebih dahulu.");return}i.toBlob(d=>{const u=new FormData;u.append("description",a),u.append("lat",s),u.append("lon",c),u.append("photo",d,"story.jpg"),o.addStory(u)},"image/jpeg")})}showLoading(){document.getElementById("upload-status").innerText="Mengunggah...",document.getElementById("upload-status").style.color="black",document.getElementById("submit-story-btn").disabled=!0}hideLoading(){document.getElementById("upload-status").innerText="",document.getElementById("submit-story-btn").disabled=!1}showSuccess(e){document.getElementById("upload-status").innerText=e,document.getElementById("upload-status").style.color="green"}showError(e){document.getElementById("upload-status").innerText=`Error: ${e}`,document.getElementById("upload-status").style.color="red"}_stopCamera(){this._mediaStream&&(this._mediaStream.getTracks().forEach(e=>e.stop()),this._mediaStream=null)}cleanup(){this._stopCamera(),this.map&&(this.map.remove(),this.map=null)}}class j{async login(e,t){const r=await fetch("/api/v1/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),o=await r.json();if(!r.ok)throw new Error(o.message);return localStorage.setItem("token",o.loginResult.token),o}async register(e,t,r){const o=await fetch("/api/v1/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:r})}),a=await o.json();if(!o.ok)throw new Error(a.message);return a}}class te{constructor(e,t){this.model=e,this.view=t}async login(e,t){try{const r=await this.model.login(e,t);this.view.showSuccess(`Selamat datang, ${r.loginResult.name}`),window.location.hash="#/home"}catch(r){this.view.showError(r.message)}}}class ne{render(){const e=document.getElementById("app-content");e.innerHTML=`
      <h2>Login</h2>
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Email" />
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Masuk</button>
      <p id="loginStatus"></p>
    `,this.afterRender()}async afterRender(){const e=new j,t=new te(e,this);document.getElementById("loginBtn").addEventListener("click",()=>{const r=document.getElementById("email").value,o=document.getElementById("password").value;t.login(r,o)})}showSuccess(e){document.getElementById("loginStatus").textContent=e}showError(e){document.getElementById("loginStatus").textContent=`Gagal: ${e}`}}class re{render(){const e=document.getElementById("app-content");e.innerHTML=`
      <h2>Daftar Akun</h2>
      <label for="name">Nama</label>
      <input type="text" id="name" placeholder="Nama" />
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Email" />
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Password (min 8 karakter)" />
      <button id="registerBtn">Daftar</button>
      <p id="registerStatus"></p>
    `,this.afterRender()}afterRender(){const e=new j;document.getElementById("registerBtn").addEventListener("click",async()=>{const t=document.getElementById("name").value,r=document.getElementById("email").value,o=document.getElementById("password").value;if(!t||!r||o.length<8){document.getElementById("registerStatus").textContent="Semua field wajib diisi dan password minimal 8 karakter";return}try{const a=await e.register(t,r,o);document.getElementById("registerStatus").textContent=a.message}catch(a){document.getElementById("registerStatus").textContent=`Gagal: ${a.message}`}})}}const M={"/":C,"/home":C,"/add":ee,"/login":ne,"/register":re};let m=null;const A=()=>localStorage.getItem("token")!==null,R=()=>{const n=window.location.hash.slice(1).toLowerCase()||"/",e=["/","/home","/add"],t=["/login","/register"];if(e.includes(n)&&!A()){window.location.hash="#/login";return}if(t.includes(n)&&A()){window.location.hash="#/";return}m&&typeof m.cleanup=="function"&&m.cleanup();const r=M[n]||M["/login"],o=new r;m=o;const a=document.getElementById("app-content");a&&(a.innerHTML="",o.render())};window.addEventListener("hashchange",R);window.addEventListener("load",()=>{R(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(n=>{console.log("Service Worker berhasil didaftarkan:",n)}).catch(n=>{console.error("Pendaftaran Service Worker gagal:",n)})});
